<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Adubação</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Função segura para configurar o Tailwind
        function configureTailwind() {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    theme: {
                        extend: {
                            fontFamily: {
                                sans: ['Inter', 'sans-serif'],
                                display: ['Poppins', 'sans-serif'],
                            },
                            colors: {
                                emerald: {
                                    450: '#10b981', // Custom shade
                                }
                            }
                        }
                    }
                };
                console.log("Tailwind configurado com sucesso.");
            } else {
                console.warn("Tailwind ainda não carregou. Tentando novamente em breve...");
                setTimeout(configureTailwind, 100);
            }
        }

        configureTailwind();
        window.addEventListener('load', configureTailwind);
    </script>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração e Inicialização do Firebase
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        
        // NOVOS ADUBOS INCLUÍDOS AQUI
        let nextComponentId = 9; // Ajustado para iniciar após os novos itens
        
        const STATE = {
            isAuthReady: false,
            calculations: [],
            lastCalculationDetails: null,
            fertilizerComponents: [
                { id: 1, name: 'Fosfato de Amônio (MAP) (11-52-00)', n: 11, p: 52, k: 0 , enabled: true },
                { id: 2, name: 'Cloreto de Potássio (KCl) (00-00-60)', n: 0, p: 0, k: 60 , enabled: true },
                { id: 3, name: 'Ureia (45-00-00)', n: 45, p: 0, k: 0 , enabled: true },
                // --- NOVOS ADUBOS ADICIONADOS ---
                { id: 4, name: 'Superfosfato Simples (SS) (00-18-00)', n: 0, p: 18, k: 0 , enabled: true },
                { id: 5, name: 'Superfosfato Triplo (ST) (00-46-00)', n: 0, p: 46, k: 0 , enabled: true },
                { id: 6, name: 'Sulfato de Amônio (21-00-00)', n: 21, p: 0, k: 0 , enabled: true },
                { id: 7, name: 'DAP (18-46-00)', n: 18, p: 46, k: 0 , enabled: true },
                { id: 8, name: 'Nitrato de Amônio (33-00-00)', n: 33, p: 0, k: 0 , enabled: true }
            ],
            optimizationOrder: ['P', 'K', 'N']
        };

        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
               
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                    }
                    STATE.isAuthReady = true;
                    document.getElementById('user-id-display').textContent = `ID: ${userId.substring(0, 8)}...`;
                    setupFirestoreListener();
                    renderComponents();
                });

            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                showModal('Modo Offline', 'App funcionando localmente.');
            }
        };

        const getCollectionRef = () => {
            if (!db || !userId) return null;
            return collection(db, `artifacts/${appId}/users/${userId}/fertilizer_calculations`);
        };

        const setupFirestoreListener = () => {
            if (!STATE.isAuthReady || !userId) return;
            const q = query(getCollectionRef());
            onSnapshot(q, (snapshot) => {
                const calculations = [];
                snapshot.forEach((doc) => {
                    calculations.push({ id: doc.id, ...doc.data() });
                });
                STATE.calculations = calculations.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.seconds : 0;
                    const timeB = b.timestamp ? b.timestamp.seconds : 0;
                    return timeB - timeA;
                });
                renderSavedCalculations();
            });
        };

        // --- UI Functions ---
        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('custom-modal').classList.remove('hidden');
            document.getElementById('custom-modal').classList.add('flex');
        };

        window.closeModal = () => {
            document.getElementById('custom-modal').classList.add('hidden');
            document.getElementById('custom-modal').classList.remove('flex');
        };
       
        window.switchTab = (tabName) => {
            const tabs = ['calculator', 'saved'];
            tabs.forEach(t => document.getElementById(`${t}-content`).classList.add('hidden'));
            
            const content = document.getElementById(`${tabName}-content`);
            content.classList.remove('hidden');
            content.classList.add('animate-fade-in');

            if (tabName === 'calculator') {
                document.getElementById('tab-indicator').style.transform = 'translateX(0%)';
                document.getElementById('calculator-tab').classList.add('text-emerald-700', 'font-bold');
                document.getElementById('calculator-tab').classList.remove('text-gray-500', 'font-medium');
                document.getElementById('saved-tab').classList.remove('text-emerald-700', 'font-bold');
                document.getElementById('saved-tab').classList.add('text-gray-500', 'font-medium');
            } else {
                document.getElementById('tab-indicator').style.transform = 'translateX(100%)';
                document.getElementById('saved-tab').classList.add('text-emerald-700', 'font-bold');
                document.getElementById('saved-tab').classList.remove('text-gray-500', 'font-medium');
                document.getElementById('calculator-tab').classList.remove('text-emerald-700', 'font-bold');
                document.getElementById('calculator-tab').classList.add('text-gray-500', 'font-medium');
            }
        }

        window.updateComponentState = (id, field, value) => {
            const component = STATE.fertilizerComponents.find(c => c.id === id);
            if (component) {
                if (field === 'enabled') { component.enabled = value; return; }
            if (['n', 'p', 'k'].includes(field)) {
                    component[field] = parseFloat(value) || 0;
                } else {
                    component[field] = value;
                }
            }
            document.getElementById('save-calculation-btn').disabled = true;
            resetResultState();
        };

        window.addComponent = () => {
            STATE.fertilizerComponents.push({
                id: nextComponentId++,
                name: `Novo Componente`,
                n: 0, p: 0, k: 0
            });
            renderComponents();
            resetResultState();
        };

        window.removeComponent = (id) => {
            STATE.fertilizerComponents = STATE.fertilizerComponents.filter(c => c.id !== id);
            renderComponents();
            resetResultState();
        };

        const resetResultState = () => {
             document.getElementById('result-card').classList.add('opacity-50', 'grayscale');
             document.getElementById('result-hint').classList.remove('hidden');
             document.getElementById('calculation-details').classList.add('hidden');
        }
       
        const reorderComponents = (nutrient, components) => {
            const key = nutrient.toLowerCase(); 
            return [...components].sort((a, b) => b[key] - a[key]);
        };

        window.renderComponents = () => {
            const container = document.getElementById('formulation-components');
            container.innerHTML = '';
           
            STATE.fertilizerComponents.forEach((c, index) => {
                const componentHtml = document.createElement('div');
                componentHtml.className = 'p-4 border border-gray-100 rounded-xl bg-gray-50 hover:bg-white hover:shadow-md transition-all duration-200 relative group';
                componentHtml.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xs font-bold">
                                ${index + 1}
                            </div>
                            <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Fonte de Nutrientes</span>
                        </div>
                        <button onclick="removeComponent(${c.id})" class="text-gray-300 hover:text-red-500 transition duration-150 p-1 rounded-full hover:bg-red-50" title="Remover">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    
                    <div class="flex items-center mb-3">
    <input type="checkbox" ${c.enabled ? "checked" : ""} onchange="updateComponentState(${c.id}, 'enabled', this.checked)" class="w-4 h-4 rounded text-emerald-600 border-gray-300 mr-2">
    <span class="text-sm font-medium text-gray-600">Usar este adubo</span>
</div>
<input type="text" value="${c.name}" oninput="updateComponentState(${c.id}, 'name', this.value)"
                        class="w-full px-3 py-2 mb-3 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all placeholder-gray-400">
                   
                    <div class="grid grid-cols-3 gap-3">
                        <div class="relative">
                            <label class="absolute -top-2 left-2 px-1 bg-gray-50 text-[10px] font-bold text-emerald-600">N %</label>
                            <input type="number" value="${c.n}" oninput="updateComponentState(${c.id}, 'n', this.value)"
                                class="w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm text-center focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
                        </div>
                        <div class="relative">
                            <label class="absolute -top-2 left-2 px-1 bg-gray-50 text-[10px] font-bold text-emerald-600">P₂O₅ %</label>
                            <input type="number" value="${c.p}" oninput="updateComponentState(${c.id}, 'p', this.value)"
                                class="w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm text-center focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
                        </div>
                        <div class="relative">
                            <label class="absolute -top-2 left-2 px-1 bg-gray-50 text-[10px] font-bold text-emerald-600">K₂O %</label>
                            <input type="number" value="${c.k}" oninput="updateComponentState(${c.id}, 'k', this.value)"
                                class="w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm text-center focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
                        </div>
                    </div>
                `;
                container.appendChild(componentHtml);
            });
        };

        window.updateOptimizationOrder = () => {
            const select = document.getElementById('optimization-order');
            STATE.optimizationOrder = select.value.split(',');
            document.getElementById('save-calculation-btn').disabled = true;
            resetResultState();
        }

        window.calculateFertilizer = () => {
            // Inputs
            const N_req = parseFloat(document.getElementById('required-N').value);
            const P_req = parseFloat(document.getElementById('required-P').value); 
            const K_req = parseFloat(document.getElementById('required-K').value); 
            const area = parseFloat(document.getElementById('area').value); 
            const culture = document.getElementById('culture').value.trim();
           
            if (!culture || isNaN(area) || isNaN(N_req) || isNaN(P_req) || isNaN(K_req) || area <= 0 || STATE.fertilizerComponents.length === 0) {
                showModal('Dados Incompletos', 'Preencha todos os campos e adicione componentes.');
                return;
            }

            let remainingN = N_req * area;
            let remainingP = P_req * area;
            let remainingK = K_req * area;
           
            let totalFertilizerUsed = 0;
            const finalComposition = [];
            const optimizationOrder = STATE.optimizationOrder;
            let availableComponents = STATE.fertilizerComponents.filter(c => c.enabled);

            optimizationOrder.forEach(nutrientKey => {
                const key = nutrientKey.toLowerCase();
                let requiredAmount = 0;
               
                if (key === 'n') requiredAmount = remainingN;
                if (key === 'p') requiredAmount = remainingP;
                if (key === 'k') requiredAmount = remainingK;
               
                if (requiredAmount <= 0.01) return;

                const prioritizedComponents = reorderComponents(nutrientKey, availableComponents);
                let nutrientSupplied = 0; 
               
                for (const component of prioritizedComponents) {
                    const nutrientContentRatio = component[key] / 100;
                    if (nutrientContentRatio <= 0 || requiredAmount <= nutrientSupplied) continue;

                    const neededForThisComponent = requiredAmount - nutrientSupplied;
                    const fertilizerAmountToUse = neededForThisComponent / nutrientContentRatio;

                    totalFertilizerUsed += fertilizerAmountToUse;
                   
                    finalComposition.push({
                        name: component.name,
                        amount: fertilizerAmountToUse,
                        n: component.n,
                        p: component.p,
                        k: component.k
                    });

                    remainingN -= fertilizerAmountToUse * (component.n / 100);
                    remainingP -= fertilizerAmountToUse * (component.p / 100);
                    remainingK -= fertilizerAmountToUse * (component.k / 100);
                   
                    nutrientSupplied += neededForThisComponent;
                    availableComponents = availableComponents.filter(c => c.id !== component.id);
                   
                    if (remainingN <= 0.01 && remainingP <= 0.01 && remainingK <= 0.01) break;
                }
            });

            // --- BALANÇO NUTRICIONAL REMOVIDO DAQUI ---
           
            // UI Update
            document.getElementById('result-output').textContent = totalFertilizerUsed.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            let compositionHtml = '';
           
            if (finalComposition.length === 0) {
                 compositionHtml += `<div class="p-4 bg-emerald-50 text-emerald-700 rounded-lg text-sm text-center">Nenhuma adição necessária.</div>`;
            } else {
                 finalComposition.forEach(item => {
                    if (item.amount > 0.01) {
                         compositionHtml += `
                            <div class="flex justify-between items-center py-3 border-b border-dashed border-gray-200 last:border-0">
                                <span class="text-gray-600 text-sm font-medium">${item.name}</span>
                                <span class="text-emerald-700 font-bold text-base bg-emerald-50 px-2 py-1 rounded-md">${item.amount.toFixed(2)} kg</span>
                            </div>
                         `;
                    }
                });
            }
            
            document.getElementById('composition-list').innerHTML = compositionHtml;
            
            // --- REMOVIDA A RENDERIZAÇÃO DOS DEFICITS ---

            // Visual Effects for "Success"
            const resultCard = document.getElementById('result-card');
            resultCard.classList.remove('opacity-50', 'grayscale');
            resultCard.classList.add('ring-2', 'ring-emerald-400', 'ring-offset-2');
            setTimeout(() => resultCard.classList.remove('ring-2', 'ring-emerald-400', 'ring-offset-2'), 1000);

            document.getElementById('result-hint').classList.add('hidden');
            document.getElementById('calculation-details').classList.remove('hidden');
            document.getElementById('save-calculation-btn').disabled = false;

            STATE.lastCalculationDetails = {
                requiredFertilizer: totalFertilizerUsed,
                finalComposition
            };
            
            resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        };
       
        window.saveCalculation = async () => {
            if (!db || !userId) {
                showModal('Erro', 'Serviço indisponível.');
                return;
            }

            if (!STATE.lastCalculationDetails) {
                 showModal('Erro', 'Realize o cálculo antes de salvar.');
                return;
            }
           
            const btn = document.getElementById('save-calculation-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Salvando...`;

            const culture = document.getElementById('culture').value.trim();
            const area = parseFloat(document.getElementById('area').value);
            const N_req = parseFloat(document.getElementById('required-N').value);
            const P_req = parseFloat(document.getElementById('required-P').value);
            const K_req = parseFloat(document.getElementById('required-K').value);

            const dataToSave = {
                culture,
                area,
                requirements: { N: N_req, P2O5: P_req, K2O: K_req },
                availableComponents: STATE.fertilizerComponents.map(c => ({
                    name: c.name, n: c.n, p: c.p, k: c.k
                })),
                optimizationOrder: STATE.optimizationOrder,
                result: {
                    requiredFertilizer: STATE.lastCalculationDetails.requiredFertilizer,
                    finalComposition: STATE.lastCalculationDetails.finalComposition.filter(c => c.amount > 0.01)
                },
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(getCollectionRef(), dataToSave);
                showModal('Salvo!', 'Cálculo registrado com sucesso.');
                STATE.lastCalculationDetails = null;
                switchTab('saved');
            } catch (error) {
                console.error("Erro ao salvar:", error);
                showModal('Erro', 'Falha ao salvar.');
            } finally {
                btn.innerHTML = originalText;
            }
        };

        const renderSavedCalculations = () => {
            const container = document.getElementById('saved-list');
            container.innerHTML = '';
           
            if (STATE.calculations.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400">
                        <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <p class="text-sm">Nenhum histórico encontrado.</p>
                    </div>`;
                return;
            }

            STATE.calculations.forEach(calc => {
                const date = calc.timestamp ? new Date(calc.timestamp.seconds * 1000).toLocaleDateString('pt-BR') : '--/--/--';
                const req = calc.requirements;
                const res = calc.result;
               
                const finalCompositionList = res.finalComposition.map(c =>
                    `<div class="flex justify-between text-sm text-gray-600 py-1 border-b border-gray-50 last:border-0">
                        <span>${c.name}</span>
                        <span class="font-medium text-emerald-700">${c.amount.toFixed(2)} kg</span>
                     </div>`
                ).join('');
               
                const card = document.createElement('div');
                card.className = 'bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-4 hover:shadow-md transition-shadow duration-200';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-display font-bold text-lg text-gray-800">${calc.culture}</h3>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="text-xs font-medium px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full">${date}</span>
                                <span class="text-xs font-medium px-2 py-0.5 bg-emerald-50 text-emerald-600 rounded-full">${calc.area} ha</span>
                            </div>
                        </div>
                        <div class="text-right">
                             <p class="text-xs text-gray-400 uppercase tracking-wider font-bold">Total</p>
                             <p class="text-xl font-bold text-emerald-600">${res.requiredFertilizer.toFixed(1)} <span class="text-sm font-normal">kg</span></p>
                        </div>
                    </div>
                   
                    <div class="grid grid-cols-3 gap-2 mb-4 text-center bg-gray-50 rounded-lg p-2">
                         <div>
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Req N</p>
                            <p class="text-xs font-semibold text-gray-700">${req.N}</p>
                         </div>
                         <div>
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Req P</p>
                            <p class="text-xs font-semibold text-gray-700">${req.P2O5}</p>
                         </div>
                         <div>
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Req K</p>
                            <p class="text-xs font-semibold text-gray-700">${req.K2O}</p>
                         </div>
                    </div>

                    <div class="space-y-1 bg-white rounded-lg">
                        ${finalCompositionList}
                    </div>
                `;
                container.appendChild(card);
            });
        };

        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>

    <style>
        body {
            background-color: #f3f4f6; 
        }
        #formulation-components::-webkit-scrollbar {
            width: 4px;
        }
        #formulation-components::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        #formulation-components::-webkit-scrollbar-thumb {
            background: #d1d5db; 
            border-radius: 4px;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="font-sans text-gray-600 antialiased pb-12">

    <div id="custom-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-900/50 backdrop-blur-sm transition-all duration-300">
        <div class="w-full max-w-sm transform overflow-hidden rounded-2xl bg-white p-6 shadow-2xl transition-all scale-100 mx-4">
            <div class="mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-emerald-100 mx-auto">
                <svg class="h-6 w-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h3 id="modal-title" class="text-center text-lg font-bold leading-6 text-gray-900 font-display">Notificação</h3>
            <div class="mt-2">
                <p id="modal-message" class="text-center text-sm text-gray-500">Conteúdo da mensagem.</p>
            </div>
            <div class="mt-6">
                <button onclick="closeModal()" class="w-full rounded-xl bg-emerald-600 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-emerald-200 transition-all hover:bg-emerald-700 hover:shadow-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2">
                    Entendi
                </button>
            </div>
        </div>
    </div>

    <div class="bg-gradient-to-br from-emerald-600 to-teal-700 pb-24 pt-8 px-4 rounded-b-[2.5rem] shadow-lg relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden opacity-10 pointer-events-none">
             <svg class="absolute top-10 -left-10 w-64 h-64 text-white" fill="currentColor" viewBox="0 0 200 200"><path d="M45,-76C58,-69,68,-57,76,-44C84,-31,90,-17,89,-3C88,11,80,25,71,37C62,49,52,59,40,66C28,73,14,77,0,77C-14,77,-28,73,-41,67C-54,61,-66,53,-74,42C-82,31,-86,17,-85,3C-84,-11,-78,-25,-69,-37C-60,-49,-48,-59,-36,-67C-24,-75,-12,-81,1,-83C14,-85,28,-83,45,-76Z" transform="translate(100 100)" /></svg>
        </div>

        <div class="max-w-xl mx-auto relative z-10 flex justify-between items-center">
            <div>
                <h1 class="text-2xl md:text-3xl font-display font-bold text-white leading-tight">Calculadora de<br/>Adubação</h1>
                <p id="user-id-display" class="text-emerald-100 text-xs mt-1 font-medium opacity-80">Conectando...</p>
            </div>
            <div class="bg-white/20 backdrop-blur-md p-2 rounded-xl border border-white/30 shadow-inner">
                 <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            </div>
        </div>
    </div>

    <div class="max-w-xl mx-auto -mt-16 px-4">
        
        <div class="bg-white rounded-2xl p-1.5 shadow-lg mb-6 flex relative z-20">
            <div id="tab-indicator" class="absolute top-1.5 left-1.5 bottom-1.5 w-[calc(50%-6px)] bg-emerald-50 rounded-xl border border-emerald-100 transition-transform duration-300 ease-in-out z-0"></div>
            <button id="calculator-tab" onclick="switchTab('calculator')" class="flex-1 py-3 text-center text-sm font-bold text-emerald-700 relative z-10 transition-colors duration-300">
                Calculadora
            </button>
            <button id="saved-tab" onclick="switchTab('saved')" class="flex-1 py-3 text-center text-sm font-medium text-gray-500 relative z-10 transition-colors duration-300">
                Histórico
            </button>
        </div>

        <div id="calculator-content" class="space-y-5">
           
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center mb-4 space-x-2">
                    <div class="p-1.5 bg-emerald-100 rounded-lg text-emerald-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    </div>
                    <h2 class="font-display font-bold text-gray-800">Dados do Cultivo</h2>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5 ml-1">Cultura</label>
                        <input type="text" id="culture" placeholder="Ex: Milho" value="Milho"
                            class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all font-medium text-gray-700">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5 ml-1">Área (ha)</label>
                        <div class="relative">
                            <input type="number" id="area" placeholder="Ex: 1.5" value="1" step="0.01"
                                class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all font-medium text-gray-700">
                            <span class="absolute right-4 top-3.5 text-gray-400 text-sm font-medium pointer-events-none">hectares</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center mb-4 space-x-2">
                    <div class="p-1.5 bg-blue-100 rounded-lg text-blue-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    </div>
                    <h2 class="font-display font-bold text-gray-800">Metas Nutricionais <span class="text-xs font-normal text-gray-400 ml-2">(kg/ha)</span></h2>
                </div>
                
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-center text-xs font-bold text-gray-500 mb-1">N</label>
                        <input type="number" id="required-N" value="150"
                            class="w-full p-3 text-center bg-blue-50 border border-blue-100 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-blue-800 font-bold">
                    </div>
                    <div>
                        <label class="block text-center text-xs font-bold text-gray-500 mb-1">P₂O₅</label>
                        <input type="number" id="required-P" value="75"
                            class="w-full p-3 text-center bg-blue-50 border border-blue-100 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-blue-800 font-bold">
                    </div>
                    <div>
                        <label class="block text-center text-xs font-bold text-gray-500 mb-1">K₂O</label>
                        <input type="number" id="required-K" value="100"
                            class="w-full p-3 text-center bg-blue-50 border border-blue-100 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-blue-800 font-bold">
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5 ml-1">Prioridade de Cálculo</label>
                    <div class="relative">
                        <select id="optimization-order" onchange="updateOptimizationOrder()" class="w-full p-3 pl-4 pr-10 bg-gray-50 border border-gray-200 rounded-xl appearance-none focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none text-sm font-medium text-gray-700">
                            <option value="P,K,N" selected>1º Fósforo → 2º Potássio → 3º Nitrogênio</option>
                            <option value="K,P,N">1º Potássio → 2º Fósforo → 3º Nitrogênio</option>
                            <option value="P,N,K">1º Fósforo → 2º Nitrogênio → 3º Potássio</option>
                            <option value="K,N,P">1º Potássio → 2º Nitrogênio → 3º Fósforo</option>
                            <option value="N,P,K">1º Nitrogênio → 2º Fósforo → 3º Potássio</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-2">
                        <div class="p-1.5 bg-orange-100 rounded-lg text-orange-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        </div>
                        <h2 class="font-display font-bold text-gray-800">Adubos</h2>
                    </div>
                    <button onclick="addComponent()" class="text-xs font-bold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full hover:bg-emerald-100 transition-colors flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Adicionar
                    </button>
                </div>
               
                <div id="formulation-components" class="space-y-3 max-h-80 overflow-y-auto pr-1">
                    </div>
            </div>

            <button onclick="calculateFertilizer()" class="w-full bg-gray-900 hover:bg-black text-white font-display font-bold py-4 rounded-2xl shadow-xl shadow-gray-300 transform active:scale-[0.98] transition-all duration-200 flex items-center justify-center group">
                <svg class="w-5 h-5 mr-2 text-emerald-400 group-hover:animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10h6M5 10s2.761 1.05 4 0 4 0 4 0m-4-7h6m-6 0v6m6-6v6"></path></svg>
                CALCULAR MISTURA
            </button>

            <div id="result-card" class="bg-white rounded-3xl p-6 shadow-lg border border-emerald-100 relative overflow-hidden opacity-50 grayscale transition-all duration-500">
                <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-50 rounded-bl-full -mr-8 -mt-8 z-0"></div>

                <div class="relative z-10">
                    <p class="text-center text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Total de Adubo Necessário</p>
                    <div class="flex justify-center items-baseline mb-6">
                        <span id="result-output" class="text-5xl font-display font-extrabold text-gray-800 tracking-tight">0,00</span>
                        <span class="text-xl font-medium text-gray-400 ml-2">kg</span>
                    </div>

                    <div id="result-hint" class="text-center text-sm text-gray-400 py-4 border-t border-dashed border-gray-200">
                        Preencha os dados e clique em calcular.
                    </div>

                    <div id="calculation-details" class="hidden space-y-4 animate-fade-in">
                        <div>
                            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Composição da Mistura</h4>
                            <div id="composition-list" class="bg-gray-50 rounded-xl p-1 border border-gray-100">
                                </div>
                        </div>
                        </div>
                </div>
            </div>

            <button id="save-calculation-btn" onclick="saveCalculation()" disabled
                class="w-full bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed text-white font-bold py-3.5 rounded-xl shadow-lg shadow-emerald-100 transform active:scale-[0.98] transition-all duration-200 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-3m-1-4l-3 3m0 0l-3 3m3-3V4"></path></svg>
                Salvar no Histórico
            </button>
            
            <div class="text-center pb-8">
                <p class="text-[10px] text-gray-400">© 2025 Calculadora Agrícola v2.1</p>
            </div>
        </div>

        <div id="saved-content" class="hidden space-y-4 pb-8">
            <div id="saved-list">
                </div>
        </div>

    </div>
</body>
</html>